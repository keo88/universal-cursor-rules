name: Notify Cursor Rules Update

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  # ì•Œë¦¼ì„ ë°›ì„ íƒ€ê²Ÿ ë¦¬í¬ì§€í† ë¦¬ ëª©ë¡ (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)
  TARGET_REPOS: 'keo88/springboot-study'
  
  # repository_dispatch ê¶Œí•œì„ ê°€ì§„ í† í° (í•„ìš”ì‹œ ë³„ë„ ì„¤ì •)
  # DISPATCH_TOKEN: Personal Access Token with repo scope

jobs:
  notify-repos:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Collect rules files and notify
      run: |
        echo "ğŸ“ Collecting rules files..."
        
        # JSON êµ¬ì¡° ì‹œì‘
        echo '{' > payload.json
        echo '  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",' >> payload.json
        echo '  "commit": {' >> payload.json
        echo '    "sha": "'${{ github.sha }}'",' >> payload.json
        echo '    "message": "'$(echo "${{ github.event.head_commit.message }}" | sed 's/"/\\"/g' | tr '\n' ' ')'",' >> payload.json
        echo '    "author": "'${{ github.event.head_commit.author.name }}'"' >> payload.json
        echo '  },' >> payload.json
        echo '  "files": [' >> payload.json
        
        # íŒŒì¼ ìˆ˜ì§‘ ë° JSON ìƒì„±
        first=true
        find . -name "*.mdc" -o -name "*.md" | while read file; do
          # ìˆ¨ê¹€ íŒŒì¼ ì œì™¸ (.github ë“±)
          if [[ "$file" == */.* ]]; then
            continue
          fi
          
          # ì²« ë²ˆì§¸ íŒŒì¼ì´ ì•„ë‹ˆë©´ ì½¤ë§ˆ ì¶”ê°€
          if [ "$first" = false ]; then
            echo '    ,' >> payload.json
          fi
          first=false
          
          # íŒŒì¼ ì •ë³´ ì¶”ì¶œ
          filename=$(basename "$file")
          filepath=$(echo "$file" | sed 's|^\./||')
          
          # íŒŒì¼ ë‚´ìš© ì½ê¸° (JSON ì´ìŠ¤ì¼€ì´í”„)
          content=$(cat "$file" | jq -Rs .)
          
          # íŒŒì¼ í¬ê¸°
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
          
          # íŒŒì¼ ë‚´ì—ì„œ íƒœê·¸ ì¶”ì¶œ (ì˜ˆ: <!-- tags: python, django -->)
          tags=$(grep -o '<!-- tags: [^>]*' "$file" | sed 's/<!-- tags: //' | sed 's/,/","/g' | sed 's/^/"/' | sed 's/$/"/' || echo '""')
          if [ "$tags" = '""' ]; then
            tags='[]'
          else
            tags='['$tags']'
          fi
          
          # íŒŒì¼ë³„ ë¶„ë¥˜ë¥¼ ìœ„í•œ ë””ë ‰í† ë¦¬ ê²½ë¡œ
          dir_path=$(dirname "$filepath")
          if [ "$dir_path" = "." ]; then
            dir_path="root"
          fi
          
          # JSON ì—”íŠ¸ë¦¬ ìƒì„±
          echo '    {' >> payload.json
          echo '      "name": "'$filename'",' >> payload.json
          echo '      "path": "'$filepath'",' >> payload.json
          echo '      "directory": "'$dir_path'",' >> payload.json
          echo '      "content": '$content',' >> payload.json
          echo '      "size": '$size',' >> payload.json
          echo '      "tags": '$tags >> payload.json
          echo '    }' >> payload.json
        done
        
        # JSON êµ¬ì¡° ì¢…ë£Œ
        echo '  ]' >> payload.json
        echo '}' >> payload.json
        
        # ìƒì„±ëœ payload í™•ì¸
        echo "ğŸ“„ Generated payload:"
        cat payload.json | jq .
        
        # ì•Œë¦¼ì„ ë°›ì„ ë¦¬í¬ì§€í† ë¦¬ ëª©ë¡ (í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        IFS=' ' read -ra REPOS <<< "${{ env.TARGET_REPOS }}"
        
        echo "ğŸ“¤ Sending notifications to repositories..."
        echo "Target repositories: ${REPOS[@]}"
        
        for repo in "${REPOS[@]}"; do
          echo "â†’ Notifying $repo..."
          
          # payloadë¥¼ client_payloadë¡œ ì „ì†¡
          response=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.DISPATCH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$repo/dispatches" \
            -d "{\"event_type\": \"cursor-rules-updated\", \"client_payload\": $(cat payload.json)}")
          
          echo "Response: $response"
          
          if [ $? -eq 0 ]; then
            echo "  âœ… Successfully notified $repo"
          else
            echo "  âŒ Failed to notify $repo"
          fi
        done
        
        echo "ğŸš€ Notification process completed!"
